<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Responsible Prompting Toolkit ‚Äì Advanced</title>

  <link rel="icon" type="image/png" href="factsh.jpeg" />

  <style>
    :root {
      --bg: #020617;
      --card-bg: rgba(15, 23, 42, 0.98);
      --card-border: rgba(148, 163, 184, 0.4);
      --card-border-soft: rgba(148, 163, 184, 0.15);
      --text-primary: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.15);
      --success: #22c55e;
      --success-soft: rgba(34, 197, 94, 0.1);
      --warning: #fbbf24;
      --warning-soft: rgba(251, 191, 36, 0.1);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
      --shadow-card: 0 14px 40px rgba(15, 23, 42, 0.9);
      --shadow-btn: 0 8px 24px rgba(8, 47, 73, 0.9);
      --font-mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      --glass: rgba(15, 23, 42, 0.92);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a 0, #020617 50%, #000 100%);
      color: var(--text-primary);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
    }

    .page {
      max-width: 1240px;
      margin: 0 auto;
      padding: 20px 16px 32px;
    }

    /* Header --------------------------------------------------- */

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
    }
    #app-logo {
      height: 128px; 
      width: 128px; 
      border-radius: 32px; 
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.9);
      object-fit: cover;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: #020617;
    }
    .title-block {
      display: flex;
      align-items:center;
      gap: 10px;
    }

    .title-pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.7rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #bfdbfe;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: radial-gradient(
        circle at top left,
        rgba(56, 189, 248, 0.22),
        rgba(15, 23, 42, 0.95)
      );
      box-shadow: 0 12px 35px rgba(56, 189, 248, 0.28);
    }

    h1 {
      font-size: 1.4rem;
      margin: 0;
      letter-spacing: 0.02em;
      color: #e5e7eb;
    }

    .subtitle {
      font-size: 0.78rem;
      color: var(--text-muted);
      max-width: 420px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    .header-pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.72rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.9);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
    }

    .badge-dot-danger {
      background: #f97373;
      box-shadow: 0 0 0 4px rgba(248, 113, 113, 0.35);
    }

    /* Layout --------------------------------------------------- */

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 0.95fr;
      gap: 16px;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      border-radius: 20px;
      padding: 14px;
      background: radial-gradient(
          circle at top left,
          rgba(56, 189, 248, 0.15),
          transparent 50%
        ),
        radial-gradient(circle at bottom right, rgba(129, 140, 248, 0.12), transparent 55%),
        rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(18px);
      min-height: 320px;
    }

    .panel h2 {
      margin: 0 0 4px;
      font-size: 0.94rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: rgba(203, 213, 225, 0.98);
    }

    .panel-subtitle {
      margin: 0 0 10px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* Cards ---------------------------------------------------- */

    .card-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      background: linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.98),
          rgba(15, 23, 42, 0.97),
          rgba(15, 23, 42, 0.98)
        );
      padding: 12px 13px;
      box-shadow: var(--shadow-card);
      position: relative;
      overflow: hidden;
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 0.9rem;
      letter-spacing: 0.02em;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .tag {
      font-size: 0.68rem;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(51, 65, 85, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #cbd5f5;
    }

    .description {
      margin: 0 0 6px;
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .explain {
      margin: 0 0 8px;
      font-size: 0.74rem;
      color: rgba(148, 163, 184, 0.9);
    }

    .explain b {
      color: #e5e7eb;
    }

    /* Inputs --------------------------------------------------- */

    .input-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(148, 163, 184, 0.9);
      margin-bottom: 4px;
    }

    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: #020617;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      resize: vertical;
      min-height: 100px;
      outline: none;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 6px 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: #020617;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      outline: none;
    }

    textarea:focus,
    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: rgba(56, 189, 248, 0.7);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3);
    }

    /* Buttons -------------------------------------------------- */

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }

    button {
      border-radius: var(--radius-pill);
      border: none;
      padding: 7px 12px;
      font-size: 0.78rem;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.12s ease,
        background 0.12s ease, border-color 0.12s ease;
      box-shadow: var(--shadow-btn);
      white-space: nowrap;
    }

    button span.emoji {
      font-size: 1rem;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      color: #0b1120;
      border: 1px solid rgba(191, 219, 254, 0.9);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(56, 189, 248, 0.9);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.95);
    }

    .btn-warn {
      background: radial-gradient(circle at top left, #f97373, #ef4444);
      color: #0b1120;
      border: 1px solid rgba(254, 202, 202, 0.9);
    }

    .btn-warn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(248, 113, 113, 0.9);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.85);
      color: #cbd5f5;
      border: 1px dashed rgba(148, 163, 184, 0.6);
    }

    .btn-ghost:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
    }

    /* Status / Output ----------------------------------------- */

    .status-line {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
      min-height: 1.2em;
    }

    pre {
      margin: 6px 0 0;
      padding: 8px 9px;
      border-radius: var(--radius-md);
      background: #020617;
      border: 1px solid var(--card-border-soft);
      color: #e5e7eb;
      font-family: var(--font-mono);
      font-size: 0.78rem;
      max-height: 240px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .output-box {
      margin-top: 6px;
    }

    .output-box textarea {
      min-height: 130px;
      max-height: 260px;
    }

    .output-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.74rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .pill-subtle {
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 0.68rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: rgba(203, 213, 225, 0.95);
    }

    /* Advanced list ------------------------------------------- */

    .advanced-section-title {
      margin: 0 0 10px;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: rgba(148, 163, 184, 0.95);
    }

    .mini-tag {
      font-size: 0.64rem;
      padding: 1px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #e5e7eb;
    }

    /*  === Visual heatmap + significance map styling === */
    .heatmap-section {
      margin-top: 6px;
    }
    .section-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(148, 163, 184, 0.9);
      margin-bottom: 4px;
    }
    .heatmap-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      margin: 2px 4px 4px 0;
      font-size: 0.75rem;
      color: #f9fafb;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.9);
    }
    .heatmap-chip .chip-score {
      font-weight: 600;
      font-size: 0.7rem;
      opacity: 0.9;
    }
    .connections-section {
      margin-top: 10px;
    }
    .connection-row {
      display: grid;
      grid-template-columns: auto 16px 1fr;
      gap: 4px;
      align-items: center;
      padding: 4px 6px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(31, 41, 55, 0.9);
      margin-bottom: 4px;
      font-size: 0.8rem;
    }
    .connection-row .prompt-word-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.18);
      border: 1px solid rgba(59, 130, 246, 0.6);
      font-weight: 500;
      color: #bfdbfe;
    }
    .connection-row .arrow {
      text-align: center;
      color: rgba(148, 163, 184, 0.9);
    }
    .connection-row .output-fragments {
      color: #e5e7eb;
    }
    .change-score-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      color: #f9fafb;
    }
    .change-score-pill span.score-number {
      font-size: 0.9rem;
    }
    .exp-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 768px) {
      .exp-grid {
        grid-template-columns: 1fr;
      }
    }
    .exp-box {
      background: #020617;
      border: 1px solid rgba(31, 41, 55, 0.9);
      border-radius: 12px;
      padding: 8px 10px;
    }
    .exp-box b {
      display: block;
      margin-bottom: 4px;
      font-size: 0.8rem;
      color: rgba(191, 219, 254, 0.95);
    }
    .exp-box pre {
      max-height: 160px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <img src="factsh.jpeg" alt="Logo" id="app-logo" />
      <div class="title-block">
       <div>
      <h1>Look inside your prompt, not just the answer.</h1>
      <p class="subtitle">
        Paste a prompt, see what your words are doing, and run mini-experiments
        to check robustness, fairness, and stability.
      </p>
      <div class="title-pill">PROMPT DEBUGGER ¬∑ ADVANCED</div>
    </div>
  </div>

  <div class="pill-row">
    <div class="header-pill">
      <span class="badge-dot"></span>
      Safe-by-default model
    </div>
    <div class="header-pill">
      <span class="badge-dot badge-dot-danger"></span>
      We try to surface risks early
    </div>
  </div>
</header>

    <main class="layout">
      <!-- Left: main workflow -->
      <section class="panel">
        <h2>1‚Äì3 ¬∑ Quick check</h2>
        <p class="panel-subtitle">
          Get a first answer, then ‚Äúlook inside‚Äù it before you trust or deploy it.
        </p>

        <div class="card-grid">
          <!-- Step 1 -->
          <div class="card">
            <h3>
              Write or paste your prompt
              <span class="tag">Step 1</span>
            </h3>
            <p class="description">
              This is the exact text you‚Äôd send to a model in production.
            </p>
            <div class="input-label">Prompt</div>
            <textarea id="prompt-input" placeholder="Explain what you want the model to do, including any constraints or safety rules."></textarea>

            <div class="btn-row">
              <button id="btn-generate" class="btn-primary">
                <span class="emoji">‚ö°</span>
                Get a model answer
              </button>
              <span class="pill-subtle">
                Uses a safe default configuration of Gemini.
              </span>
            </div>
            <div id="status-generate" class="status-line"></div>
          </div>

          <!-- Step 2 -->
          <div class="card">
            <h3>
              Answer from the model
              <span class="tag">Step 2</span>
            </h3>
            <p class="description">
              Read this as if you were a user. We‚Äôll use it as the ‚Äúbaseline‚Äù for all later tests.
            </p>
            <div class="output-box">
              <div class="output-label">
                <span>Model answer</span>
                <span class="pill-subtle">Editable if you want to paste your own.</span>
              </div>
              <textarea id="output-display" placeholder="The model's answer will appear here. You can also paste an answer from somewhere else."></textarea>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="card">
            <h3>
              Look inside this answer
              <span class="tag">Step 3</span>
            </h3>
            <p class="description">
              See which words in your prompt seem to steer the answer, and how they connect to specific parts of the response.
            </p>
            <p class="explain">
              <b>What:</b> A word-level ‚Äúheatmap‚Äù and prompts ‚Üí answer links.<br />
              <b>Why:</b> Helps you understand which parts of your prompt matter most.<br />
              <b>How:</b> Click <b>Look inside this answer</b>, then use the suggested words for experiments below.
            </p>

            <div class="btn-row">
              <button id="btn-analyze" class="btn-secondary" disabled>
                <span class="emoji">üß†</span>
                Look inside this answer
              </button>
            </div>
            <div id="status-analyze" class="status-line"></div>
            <pre id="analysis-display"><em>Run the quick analysis to see a heatmap and input ‚Üí output links.</em></pre>
          </div>

          <!-- Step 4 / Experiments -->
          <div class="card">
            <h3>
              Try a small experiment
              <span class="tag">Step 4</span>
            </h3>
            <p class="description">
              Run quick ‚Äúbefore/after‚Äù tests on your prompt to see how sensitive the answer is.
            </p>

            <div class="input-label">Words or mapping</div>
            <input
              type="text"
              id="ablation-input"
              placeholder="Example: formal, polite  ¬∑ or ¬∑ doctor->teacher, he->she"
            />

            <p class="explain">
              <b>Ablation:</b> Remove words (e.g., ‚Äúformal, polite‚Äù).<br />
              <b>Swap:</b> Replace pairs (e.g., ‚Äúdoctor->teacher, he->she‚Äù).
            </p>

            <div class="btn-row">
              <button id="btn-ablate" class="btn-secondary" disabled>
                <span class="emoji">üß™</span>
                Remove these words
              </button>
              <button id="btn-counterfactual" class="btn-secondary" disabled>
                <span class="emoji">üîÅ</span>
                Swap these words
              </button>
            </div>
            <div id="status-ablation" class="status-line"></div>
            <div id="status-counterfactual" class="status-line"></div>
            <pre id="experiment-display"><em>Run one of the tests above to see a before-and-after view.</em></pre>
          </div>
        </div>
      </section>

      <!-- Right: advanced checks -->
      <section class="panel">
        <h2>4‚Äì6 ¬∑ Advanced checks</h2>
        <p class="panel-subtitle">
          Once you‚Äôve run the basic analysis, these tools dig into specific risks.
        </p>

        <div class="card-grid">
          <!-- Word influence -->
          <div class="card">
            <h3>
              Word influence check
              <span class="tag">Causal</span>
            </h3>
            <p class="description">
              Estimate which words would cause the biggest change if you tweaked them.
            </p>
            <p class="explain">
              <b>What:</b> A ranked list of ‚Äúhigh-leverage‚Äù words.<br />
              <b>Why:</b> Good targets if you want to safely tune the answer.<br />
              <b>How:</b> After the quick analysis, press <b>Check word influence</b>.
            </p>
            <button id="btn-causal" class="btn-secondary" disabled>Check word influence</button>
            <div id="status-causal" class="status-line"></div>
            <pre id="causal-display"></pre>
          </div>

          <!-- Fragility -->
          <div class="card">
            <h3>
              Fragility map
              <span class="tag">Stability</span>
            </h3>
            <p class="description">
              Spot phrases where tiny paraphrases could flip the meaning or tone.
            </p>
            <p class="explain">
              <b>What:</b> Words/phrases with high ‚Äúfragility‚Äù.<br />
              <b>Why:</b> Helps you rewrite prompts so they‚Äôre less brittle.<br />
              <b>How:</b> After the quick analysis, press <b>Map fragile spots</b>.
            </p>
            <button id="btn-fragility" class="btn-secondary" disabled>Map fragile spots</button>
            <div id="status-fragility" class="status-line"></div>
            <pre id="fragility-display"></pre>
          </div>

          <!-- Paraphrase robustness -->
          <div class="card">
            <h3>
              Paraphrase robustness
              <span class="tag">Consistency</span>
            </h3>
            <p class="description">
              See how stable the answer is if you rephrase the same instruction.
            </p>
            <p class="explain">
              <b>What:</b> Several paraphrased prompts with expected change levels.<br />
              <b>Why:</b> Good signal for whether your prompt will behave in the wild.<br />
              <b>How:</b> After the quick analysis, press <b>Check paraphrase robustness</b>.
            </p>
            <button id="btn-paraphrase" class="btn-secondary" disabled>Check paraphrase robustness</button>
            <div id="status-paraphrase" class="status-line"></div>
            <pre id="paraphrase-display"></pre>
          </div>

          <!-- Bias probe -->
          <div class="card">
            <h3>
              Fairness / bias probe
              <span class="tag">Risk</span>
            </h3>
            <p class="description">
              Check how the answer might shift when demographic attributes change.
            </p>
            <p class="explain">
              <b>What:</b> Potential differences by gender, race, age, etc.<br />
              <b>Why:</b> Helps you notice if the answer treats people differently when only one detail changes.<br />
              <b>How:</b> After the quick analysis, press <b>Run fairness check</b> and read the short notes per category.
            </p>
            <button id="btn-bias" class="btn-warn" disabled>Run fairness check</button>
            <div id="status-bias" class="status-line"></div>
            <pre id="bias-display"></pre>
          </div>

          <!-- Prompt genome -->
          <div class="card">
            <h3>
              Prompt building blocks
              <span class="tag">Structure</span>
            </h3>
            <p class="description">
              Break your prompt into small pieces and see what role each piece seems to play.
            </p>
            <p class="explain">
              <b>What:</b> Groups of words that act like ‚Äúblocks‚Äù for tone, safety, length, or task.<br />
              <b>Why:</b> Makes it easier to rewrite your prompt by tweaking one block at a time instead of the whole thing.<br />
              <b>How:</b> After the quick analysis, click <b>Show building blocks</b> to see names and short explanations.
            </p>
            <button id="btn-genome" class="btn-secondary" disabled>Show building blocks</button>
            <div id="status-genome" class="status-line"></div>
            <pre id="genome-display"></pre>
          </div>

          <!-- Temperature sensitivity -->
          <div class="card">
            <h3>
              Temperature sensitivity
              <span class="tag">Tuning</span>
            </h3>
            <p class="description">
              Understand how ‚Äúcreative‚Äù you can set the model before it starts drifting.
            </p>
            <p class="explain">
              <b>What:</b> Expected answer style and risk at different temperatures.<br />
              <b>Why:</b> Helps you tune for creativity without losing control.<br />
              <b>How:</b> Press <b>Check temperature sensitivity</b> any time.
            </p>
            <button id="btn-temp" class="btn-secondary" disabled>Check temperature sensitivity</button>
            <div id="status-temp" class="status-line"></div>
            <pre id="temp-display"></pre>
          </div>

          <!-- Reliability certificate -->
          <div class="card">
            <h3>
              Reliability certificate
              <span class="tag">Summary</span>
            </h3>
            <p class="description">
              Get a single A‚ÄìD grade and a brief summary of strengths, risks, and suggested fixes.
            </p>
            <p class="explain">
              <b>What:</b> A compact, non-technical report card.<br />
              <b>Why:</b> Good final check before you put a prompt into production.<br />
              <b>How:</b> After the quick analysis, press <b>Get reliability certificate</b>.
            </p>
            <button id="btn-reliability" class="btn-secondary" disabled>Get reliability certificate</button>
            <div id="status-reliability" class="status-line"></div>
            <pre id="reliability-display"></pre>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const promptInput = document.getElementById("prompt-input");
    const outputDisplay = document.getElementById("output-display");

    const btnGenerate = document.getElementById("btn-generate");
    const btnAnalyze = document.getElementById("btn-analyze");
    const btnAblate = document.getElementById("btn-ablate");
    const btnCounterfactual = document.getElementById("btn-counterfactual");

    const statusGenerate = document.getElementById("status-generate");
    const statusAnalyze = document.getElementById("status-analyze");
    const statusAblation = document.getElementById("status-ablation");
    const statusCounterfactual = document.getElementById("status-counterfactual");

    const analysisDisplay = document.getElementById("analysis-display");
    const ablationInput = document.getElementById("ablation-input");
    const experimentDisplay = document.getElementById("experiment-display");

    // Advanced elements
    const btnCausal = document.getElementById("btn-causal");
    const btnFragility = document.getElementById("btn-fragility");
    const btnParaphrase = document.getElementById("btn-paraphrase");
    const btnBias = document.getElementById("btn-bias");
    const btnGenome = document.getElementById("btn-genome");
    const btnTemp = document.getElementById("btn-temp");
    const btnReliability = document.getElementById("btn-reliability");

    const statusCausal = document.getElementById("status-causal");
    const statusFragility = document.getElementById("status-fragility");
    const statusParaphrase = document.getElementById("status-paraphrase");
    const statusBias = document.getElementById("status-bias");
    const statusGenome = document.getElementById("status-genome");
    const statusTemp = document.getElementById("status-temp");
    const statusReliability = document.getElementById("status-reliability");

    const causalDisplay = document.getElementById("causal-display");
    const fragilityDisplay = document.getElementById("fragility-display");
    const paraphraseDisplay = document.getElementById("paraphrase-display");
    const biasDisplay = document.getElementById("bias-display");
    const genomeDisplay = document.getElementById("genome-display");
    const tempDisplay = document.getElementById("temp-display");
    const reliabilityDisplay = document.getElementById("reliability-display");

    const appState = {
      original_prompt: "",
      original_output: "",
      original_analysis: null,
      analysis_done: false,
    };

    // Map an impact score (1‚Äì5) to a blue ‚Üí red background color
    function scoreToColor(score, maxScore = 5) {
      const s = Math.max(0, Math.min(score || 0, maxScore));
      const hue = 220 - (s / maxScore) * 220; // 220 (blue) ‚Üí 0 (red)
      return `hsl(${hue}, 80%, 35%)`;
    }

    // Render heatmap + prompt‚Üíoutput significance map
    function renderPromptAnalysis(container, data) {
      if (!container) return;
      if (!data || !Array.isArray(data.heatmap_data)) {
        container.innerHTML =
          '<em>Run ‚ÄúLook inside this answer‚Äù to see highlighted words and links.</em>';
        return;
      }

      const heatmap = data.heatmap_data
        .map((h) => {
          const score = Number(h.impact_score || 0);
          const color = scoreToColor(score);
          const label = (h.word || "").trim() || "(blank)";
          return `
        <span class="heatmap-chip" style="background:${color};">
          <span>${label}</span>
          <span class="chip-score">${score.toFixed(1)}</span>
        </span>`;
        })
        .join("");

      const connections = (data.connections || [])
        .map((c) => {
          const word = (c.prompt_word || "").trim() || "(word)";
          const score = Number(c.impact_score || 0);
          const influenced = (c.influenced_output_words || [])
            .filter(Boolean)
            .join(", ");
          return `
        <div class="connection-row">
          <span class="prompt-word-pill">${word} (${score.toFixed(1)})</span>
          <span class="arrow">‚Üí</span>
          <span class="output-fragments">${
            influenced || "No clear fragments"
          }</span>
        </div>`;
        })
        .join("");

      container.innerHTML = `
      <div class="heatmap-section">
        <div class="section-label">Prompt word influence (hotter = more impact)</div>
        ${heatmap || "<em>No strong signals detected.</em>"}
      </div>
      <div class="connections-section">
        <div class="section-label">How words shaped the answer</div>
        ${connections || "<em>No clear prompt ‚Üí answer links.</em>"}
      </div>`;
    }

    // Build a colored change-score pill
    function renderChangeScorePill(score, summary) {
      const s = Number(score || 0);
      let bg = "linear-gradient(120deg,#22c55e,#16a34a)"; // low change = green
      if (s >= 3 && s <= 6) {
        bg = "linear-gradient(120deg,#facc15,#eab308)"; // medium = yellow
      } else if (s > 6) {
        bg = "linear-gradient(120deg,#f97373,#ef4444)"; // high = red
      }
      return `
      <div class="change-score-pill" style="background:${bg};">
        <span>Change score (1‚Äì10):</span>
        <span class="score-number">${s.toFixed(1)}</span>
        <span>${summary ? "‚Äì " + summary : ""}</span>
      </div>`;
    }

    let isLoadingBasic = false;

    function setStatus(el, msg, isError = false) {
      if (!el) return;
      el.textContent = msg;
      el.style.color = isError ? "#f97373" : "var(--text-muted)";
    }

    function clearStatuses() {
      [
        statusGenerate,
        statusAnalyze,
        statusAblation,
        statusCounterfactual,
        statusCausal,
        statusFragility,
        statusParaphrase,
        statusBias,
        statusGenome,
        statusTemp,
        statusReliability,
      ].forEach((el) => el && (el.textContent = ""));
    }

    function updateButtonStates() {
      const hasPrompt = !!promptInput.value.trim();
      const hasOutput = !!outputDisplay.value.trim();
      const basicReady = hasPrompt && !isLoadingBasic;
      const postAnalysisEnabled = basicReady && appState.analysis_done;

      btnGenerate.disabled = !hasPrompt || isLoadingBasic;
      btnAnalyze.disabled = !basicReady;

      btnAblate.disabled = !postAnalysisEnabled;
      btnCounterfactual.disabled = !postAnalysisEnabled;

      [
        btnCausal,
        btnFragility,
        btnParaphrase,
        btnBias,
        btnGenome,
        btnTemp,
        btnReliability,
      ].forEach((btn) => {
        if (!btn) return;
        btn.disabled = !postAnalysisEnabled;
      });
    }

    function requireBase(el, needAnalysis = false) {
      if (!appState.original_prompt || !appState.original_output) {
        setStatus(el, "First, enter a prompt and get an answer.", true);
        return false;
      }
      if (needAnalysis && !appState.analysis_done) {
        setStatus(el, "Run ‚ÄúLook inside this answer‚Äù first.", true);
        return false;
      }
      return true;
    }

    promptInput.addEventListener("input", () => {
      appState.original_prompt = promptInput.value;
      updateButtonStates();
    });

    outputDisplay.addEventListener("input", () => {
      appState.original_output = outputDisplay.value;
      updateButtonStates();
    });

    // 1. Generate
    btnGenerate.addEventListener("click", async () => {
      clearStatuses();
      const prompt = promptInput.value.trim();
      if (!prompt) {
        setStatus(statusGenerate, "Please enter a prompt.", true);
        return;
      }

      isLoadingBasic = true;
      updateButtonStates();
      setStatus(statusGenerate, "Asking the model...");
      analysisDisplay.innerHTML =
        "<em>We‚Äôll show the heatmap and links after analysis.</em>";
      experimentDisplay.innerHTML =
        "<em>Run one of the tests above to see a before-and-after view.</em>";
      appState.original_analysis = null;
      appState.analysis_done = false;

      try {
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });

        const data = await res.json();
        if (!res.ok || data.error) {
          throw new Error(data.error || `Server error ${res.status}`);
        }

        appState.original_prompt = prompt;
        appState.original_output = data.output || "";
        outputDisplay.value = appState.original_output;
        setStatus(
          statusGenerate,
          "Answer ready. Now click ‚ÄúLook inside this answer‚Äù."
        );
      } catch (err) {
        console.error(err);
        setStatus(statusGenerate, err.message, true);
      } finally {
        isLoadingBasic = false;
        updateButtonStates();
      }
    });

    // 2. Analyze
    btnAnalyze.addEventListener("click", async () => {
      clearStatuses();

      if (!requireBase(statusAnalyze)) return;

      isLoadingBasic = true;
      updateButtonStates();
      setStatus(statusAnalyze, "Looking inside the answer...");

      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: appState.original_prompt,
            output: appState.original_output,
          }),
        });

        const data = await res.json();
        if (!res.ok || data.error) {
          throw new Error(data.error || `Server error ${res.status}`);
        }

        appState.original_analysis = data;
        appState.analysis_done = true;

        // Visual heatmap + prompt ‚Üí answer significance map
        renderPromptAnalysis(analysisDisplay, data);

        // Auto-suggest words for ablation based on high impact
        if (Array.isArray(data.heatmap_data)) {
          const topWords = data.heatmap_data
            .filter((x) => (x.impact_score || 0) >= 3.5 && x.word)
            .map((x) => x.word);
          ablationInput.value = [...new Set(topWords)].join(", ");
        }

        setStatus(
          statusAnalyze,
          "Done. All tests and deeper checks are now unlocked."
        );
      } catch (err) {
        console.error(err);
        setStatus(statusAnalyze, err.message, true);
      } finally {
        isLoadingBasic = false;
        updateButtonStates();
      }
    });

    // 3a. Ablation
    btnAblate.addEventListener("click", async () => {
      clearStatuses();
      if (!requireBase(statusAblation, true)) return;

      const changes = ablationInput.value.trim();
      if (!changes) {
        setStatus(statusAblation, "Type at least one word to remove.", true);
        return;
      }

      isLoadingBasic = true;
      updateButtonStates();
      setStatus(statusAblation, "Trying the prompt without those words...");

      try {
        const res = await fetch("/api/run_experiment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            mode: "ablation",
            original_prompt: appState.original_prompt,
            original_output: appState.original_output,
            changes_text: changes,
          }),
        });

        const data = await res.json();
        if (!res.ok || data.error) {
          throw new Error(data.error || `Server error ${res.status}`);
        }

        experimentDisplay.innerHTML =
          `<div class="exp-grid">
              <div class="exp-box">
                <b>Original prompt</b>
                <pre>${appState.original_prompt}</pre>
              </div>
              <div class="exp-box">
                <b>Prompt without those words</b>
                <pre>${data.new_prompt}</pre>
              </div>
            </div>
            <div class="exp-grid" style="margin-top:8px;">
              <div class="exp-box">
                <b>Original answer</b>
                <pre>${appState.original_output}</pre>
              </div>
              <div class="exp-box">
                <b>New answer</b>
                <pre>${data.new_output}</pre>
              </div>
            </div>
            <div style="margin-top:8px;">
              ${renderChangeScorePill(
                data.change_data.semantic_change_score,
                data.change_data.change_summary
              )}
            </div>`;
        setStatus(statusAblation, "Test finished.");
      } catch (err) {
        console.error(err);
        setStatus(statusAblation, err.message, true);
      } finally {
        isLoadingBasic = false;
        updateButtonStates();
      }
    });

    // 3b. Counterfactual swap
    btnCounterfactual.addEventListener("click", async () => {
      clearStatuses();
      if (!requireBase(statusCounterfactual, true)) return;

      const changes = ablationInput.value.trim();
      if (!changes) {
        setStatus(
          statusCounterfactual,
          "Provide mappings like doctor->teacher, he->she.",
          true
        );
        return;
      }

      isLoadingBasic = true;
      updateButtonStates();
      setStatus(
        statusCounterfactual,
        "Trying the prompt with those words swapped..."
      );

      try {
        const res = await fetch("/api/run_experiment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            mode: "swap",
            original_prompt: appState.original_prompt,
            original_output: appState.original_output,
            changes_text: changes,
          }),
        });

        const data = await res.json();
        if (!res.ok || data.error) {
          throw new Error(data.error || `Server error ${res.status}`);
        }

        experimentDisplay.innerHTML =
          `<div class="exp-grid">
              <div class="exp-box">
                <b>Original prompt</b>
                <pre>${appState.original_prompt}</pre>
              </div>
              <div class="exp-box">
                <b>Prompt with swapped words</b>
                <pre>${data.new_prompt}</pre>
              </div>
            </div>
            <div class="exp-grid" style="margin-top:8px;">
              <div class="exp-box">
                <b>Original answer</b>
                <pre>${appState.original_output}</pre>
              </div>
              <div class="exp-box">
                <b>New answer</b>
                <pre>${data.new_output}</pre>
              </div>
            </div>
            <div style="margin-top:8px;">
              ${renderChangeScorePill(
                data.change_data.semantic_change_score,
                data.change_data.change_summary
              )}
            </div>`;
        setStatus(statusCounterfactual, "Test finished.");
      } catch (err) {
        console.error(err);
        setStatus(statusCounterfactual, err.message, true);
      } finally {
        isLoadingBasic = false;
        updateButtonStates();
      }
    });

    // Helper for advanced POSTs
    async function runAdvanced(
      path,
      body,
      statusEl,
      displayEl,
      unlockText = "Done."
    ) {
      clearStatuses();
      if (!requireBase(statusEl, true)) return;

      setStatus(statusEl, "Checking...");
      displayEl.textContent = "";

      try {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: appState.original_prompt,
            output: appState.original_output,
            ...body,
          }),
        });

        const data = await res.json();
        if (!res.ok || data.error) {
          throw new Error(data.error || `Server error ${res.status}`);
        }

        displayEl.textContent = JSON.stringify(data, null, 2);
        setStatus(statusEl, unlockText);
      } catch (err) {
        console.error(err);
        setStatus(statusEl, err.message, true);
      }
    }

    // Advanced hooks
    btnCausal.addEventListener("click", () =>
      runAdvanced(
        "/api/causal_heatmap",
        {},
        statusCausal,
        causalDisplay,
        "Word influence estimated."
      )
    );

    btnFragility.addEventListener("click", () =>
      runAdvanced(
        "/api/fragility_map",
        {},
        statusFragility,
        fragilityDisplay,
        "Fragility map ready."
      )
    );

    btnParaphrase.addEventListener("click", () =>
      runAdvanced(
        "/api/paraphrase_robustness",
        {},
        statusParaphrase,
        paraphraseDisplay,
        "Paraphrase robustness estimated."
      )
    );

    btnBias.addEventListener("click", () =>
      runAdvanced(
        "/api/bias_probe",
        {},
        statusBias,
        biasDisplay,
        "Fairness check completed."
      )
    );

    btnGenome.addEventListener("click", () =>
      runAdvanced(
        "/api/prompt_genome",
        {},
        statusGenome,
        genomeDisplay,
        "Prompt building blocks identified."
      )
    );

    btnTemp.addEventListener("click", () =>
      runAdvanced(
        "/api/temperature_sensitivity",
        {},
        statusTemp,
        tempDisplay,
        "Temperature sensitivity mapped."
      )
    );

    btnReliability.addEventListener("click", () =>
      runAdvanced(
        "/api/reliability_certificate",
        {},
        statusReliability,
        reliabilityDisplay,
        "Reliability certificate generated."
      )
    );

    // Initial state
    updateButtonStates();
  </script>
</body>
</html>